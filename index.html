<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hanggliding Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/favicon.png" />
</head>
<body>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://unpkg.com/elm-debug-transformer@1.0.1/dist/elm-console-debug.js"></script>
  <script src="https://unpkg.com/elm-canvas@2.2/elm-canvas.js"></script>
  <script src="app.js"></script>
  <script>
    ElmConsoleDebug.register({simple_mode: true})

    const app = Elm.Main.init({
      flags: {
      }
    });
  </script>

  <canvas id="renderCanvas" height="1024px" width="1920px"></canvas>
  <script type="text/javascript">

    setTimeout(function() {
       var heightMap = document.getElementById("heightMap").childNodes.item("canvas");

        var unpackTerrarium = function(r, g, b) {
            return ((r * 0.299 + g * 0.587 + b * 0.114) / 3 )
        }

        var decodeData = function(canvas) {
          var ctx = canvas.getContext('2d');
          var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          var data = imageData.data;
          for (var i = 0; i < data.length; i += 4) {
            let lightness = unpackTerrarium(data[i], data[i + 1], data[i + 2]);

            data[i] = lightness;
            data[i + 1] = lightness;
            data[i + 2] = lightness;
          }

          ctx.putImageData(imageData, 0, 0)
        }
        decodeData(heightMap)
    }, 3000);


    
    var canvas = document.getElementById("renderCanvas");
    var engine = new BABYLON.Engine(canvas, true);
    var createScene  = function() {
      var scene = new BABYLON.Scene(engine);
      // Light
      var spot = new BABYLON.PointLight("spot", new BABYLON.Vector3(0, 30, 10), scene);
      spot.diffuse = new BABYLON.Color3(1, 1, 1);
      spot.specular = new BABYLON.Color3(0, 0, 0);

      // Camera
      var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0.8, 100, BABYLON.Vector3.Zero(), scene);
      camera.lowerBetaLimit = 0.1;
      camera.upperBetaLimit = (Math.PI / 2) * 0.9;
      camera.lowerRadiusLimit = 30;
      camera.upperRadiusLimit = 150;
      camera.attachControl(canvas, true);


      var imageMapUrl = document.getElementById("imageMap").childNodes.item("canvas").toDataURL();
      var heightMapUrl = document.getElementById("heightMap").childNodes.item("canvas").toDataURL();
   
      // Ground
      var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
      groundMaterial.diffuseTexture = new BABYLON.Texture(imageMapUrl, scene);


      var ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", heightMapUrl, 200, 200, 250, 0, 10, scene, false);
      ground.material = groundMaterial;		
      return scene;
    };
      
    setTimeout(function() {
      var scene = createScene();
      engine.runRenderLoop(function() {
        scene.render();
      });
    }, 4000)
      
  </script>
</body>
</html>
